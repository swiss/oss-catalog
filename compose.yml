services:
  api:
    extends:
      file: developers-italia-api/docker-compose.yml
      service: api
    env_file: ".env" # Must define PASETO_KEY
    environment:
      - GOFLAGS=-buildvcs=false
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/v1/publishers"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  db:
    extends:
      file: developers-italia-api/docker-compose.yml
      service: db

  crawler:
    build:
      context: ./publiccode-crawler
    depends_on:
      - api
    networks:
      - default
    env_file: ".env" # Must define PASETO_KEY and GITHUB_TOKEN
    environment:
      # - API_BASEURL=https://oss-catalog-api.ocp.cloudscale.puzzle.ch/v1
      - API_BASEURL=http://api:3000/v1/
      - API_BEARER_TOKEN=${API_BEARER_TOKEN}

  client:
    build:
      context: .
      dockerfile: Dockerfile
      network: host
      args:
        - API_BASEURL=http://localhost:3000/v1
    depends_on:
      - api
    networks:
      - default
    ports:
      - "8081:8080"
volumes:
  pgdata:
